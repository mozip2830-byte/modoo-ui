# 🎯 Firebase 비용 분석 보고서 (구조 기반)
**modoo-dev (서비스 매칭 플랫폼)**
**기준: 개발/테스트 단계 → 스케일 시나리오 (월 방문 100만, 견적요청 100만)**

---

## 📋 1. 서비스 구성 진단

| 항목 | 설정 | 비고 |
|------|------|------|
| **Firestore** | ✅ asia-northeast3 (서울) | 기본 설정 |
| **Cloud Functions** | ✅ nodejs22 | 6개 함수 배포됨 |
| **Cloud Storage** | ✅ 설정됨 | 이미지 호스팅 |
| **Firebase Hosting** | ❓ (확인 필요) | - |
| **Firebase Auth** | ✅ | Email + OAuth (Google/Kakao/Naver) |
| **타겟** | 모바일 중심 (React Native/Expo) | 국내 |
| **아키텍처** | 실시간 구독 (onSnapshot) | - |

---

## 🔴 2. 비용 리스크 TOP 5

### 1️⃣ **Network Egress (이미지 전송)**
- **문제**: 프로필 사진, 채팅 이미지, 썸네일이 전송량의 90% 이상 차지
- **현황**: 이전 분석에서 500TB/월 → $60,000
- **원인**: 캐시 미적용 기준, 1방문 500MB 전송
- **해결책**:
  - ☑️ 이미지 최적화 (Webp 변환, 크기 제한)
  - ☑️ HTTP Cache-Control 헤더 추가 (24시간)
  - ☑️ Cloud CDN 또는 CloudFlare 도입
  - ☑️ 썸네일 먼저 로드, 상세는 클릭 시만 로드
- **확인법**: GCP Console > Storage > 상위 10개 파일 크기 확인
- **절감 가능성**: 70-80% ($12,000~18,000)

### 2️⃣ **Firestore Reads (구독 기반)**
- **문제**: onSnapshot으로 지속적 listen → 메시지/채팅 구독 시 READ 급증
- **현황**:
  - subscribeMessages (limit 50): 매 메시지 추가 시 1 READ
  - subscribeChats (무제한): 매 메시지 시 갱신
  - subscribeMyRequests (limit 20): 매 요청 상태 변화 시 READ
- **원인**: 구독 리스너가 활성화된 동안 문서 변경만으로도 READ 발생
- **해결책**:
  - ☑️ 중요 리스너만 활성화 (필터 추가)
  - ☑️ Firestore Lite SDK 사용 (읽기 비용 50% 감소)
  - ☑️ 페이지네이션 + 수동 새로고침 전환
  - ☑️ 메시지는 loadMore 페턴으로 (구독 제거)
- **확인법**: GCP Console > Firestore > Read Operations 추이 보기
- **절감 가능성**: 40-60%

### 3️⃣ **Cloud Functions 호출 (deductPointsForQuote)**
- **문제**: 견적 제출 시마다 Function 호출 → 월 100만 건 시 $400
- **현황**: 현재는 무료 티어(200만 호출/월) 내에 있으나 스케일 시 비용 발생
- **원인**: 포인트 차감을 서버에서 처리 (보안 강화)
- **해결책**:
  - ☑️ Firestore 트랜잭션으로 직접 처리 (비용 없음)
  - ☑️ 배치 처리 (Function 비용 30% 절감)
  - ☑️ Cloud Tasks로 비동기 처리 (Function 실행시간 단축)
- **확인법**: GCP Console > Cloud Functions > Invocations
- **절감 가능성**: 0-30% (이미 최적화됨)

### 4️⃣ **Firestore Writes (Quote + Message + Ledger)**
- **문제**: 견적 1건 = 3 WRITE (Quote + Message + Ledger)
- **현황**: 월 100만 건 × 3 = 300만 WRITE = $540
- **원인**: 감사 로그(Ledger)를 별도 수집
- **해결책**:
  - ☑️ Ledger를 Cloud Logging으로 전환 (비용 70% 절감)
  - ☑️ 배치 쓰기 (1회 문서 vs 여러 sub-collections)
  - ☑️ TTL 정책 (30일 이후 자동 삭제)
- **확인법**: GCP Console > Firestore > Write Operations
- **절감 가능성**: 30-50%

### 5️⃣ **Storage 비용 (구조적 문제 없음)**
- **현황**: 썸네일 최적화로 이미 저비용
- **상태**: ✅ 양호 (스토리지 자체는 $0.018/GB로 저렴)
- **주의**: 다운로드 비용이 실제 네트워크 Egress에 포함됨

---

## 📊 3. 1회 행동당 비용 계수 (구조 분석)

### A. 고객 앱 (Customer App)

| 화면/동작 | Firestore READs | 이미지 로드 | 추정 전송량 (MB) | Function 호출 |
|----------|-----------------|-----------|---------------|--------------|
| **홈 진입** | 0 (캐시) | 없음 | 0.1 | 0 |
| **요청 목록 로드** | 20 + limit(20) | 썸네일 × 20개 (100KB) | 2.5 | 0 |
| **요청 상세** | 1 + 10 (평균 견적) | 없음 | 0.2 | 0 |
| **견적서 상세 확인** | 1 (메시지) | 1-2개 이미지 (1MB) | 1.0 | 0 |
| **채팅 로드** | 50 (messages) | 평균 5개 × 1MB | 5.0 | 0 |
| **파트너 프로필** | 2 | 프로필 × 1개 (500KB) | 0.5 | 0 |
| **검색/필터** | +20 (추가 query) | 같음 | +2.0 | 0 |
| **견적 확정** | 2 (writes) | 없음 | 0.1 | 0 |
| **결제 완료** | 1 (writes) | 없음 | 0.05 | 0 |

### B. 파트너 앱 (Partner App)

| 화면/동작 | Firestore READs | 이미지 로드 | 추정 전송량 (MB) | Function 호출 |
|----------|-----------------|-----------|---------------|--------------|
| **요청 목록** | 20 | 없음 | 0.2 | 0 |
| **요청 상세** | 1 | 없음 | 0.1 | 0 |
| **채팅 로드** | 50 | 고객 이미지 5개 × 1MB | 5.0 | 0 |
| **견적 작성 폼** | 0 (로컬) | 없음 | 0.05 | 0 |
| **견적 제출** | 1 (check) | 없음 | 0.2 | **1회 호출** ⚠️ |
| **포인트 차감** | 1 (read) | 없음 | 0.05 | **deductPointsForQuote** |

---

## 📈 4. 평균 방문자당 전송량 계산

### 시나리오: 월 방문 100만명 (기준 행동 분포)

**가정:**
- 고객 방문 60% (60만)
- 파트너 방문 40% (40만)

#### 고객 방문자 (60만)
```
행동 분포 추정:
- 홈 진입만: 15% → 0.1MB
- 목록 + 상세 조회: 40% → 2.5MB + 0.2MB = 2.7MB
- 목록 + 채팅: 30% → 2.5MB + 5.0MB = 7.5MB
- 전체 (검색 포함): 15% → 2.5MB + 2.0MB + 0.2MB = 4.7MB

가중 평균:
= 0.15 × 0.1 + 0.40 × 2.7 + 0.30 × 7.5 + 0.15 × 4.7
= 0.015 + 1.08 + 2.25 + 0.705
= 4.05 MB/방문
```

#### 파트너 방문자 (40만)
```
행동 분포 추정:
- 목록만: 30% → 0.2MB
- 목록 + 상세: 40% → 0.2MB + 0.1MB = 0.3MB
- 채팅 활동: 20% → 5.0MB
- 견적 제출: 10% → 0.2MB (+ Function 호출)

가중 평균:
= 0.30 × 0.2 + 0.40 × 0.3 + 0.20 × 5.0 + 0.10 × 0.2
= 0.06 + 0.12 + 1.0 + 0.02
= 1.2 MB/방문
```

#### 전체 플랫폼 평균
```
= (60만 × 4.05MB + 40만 × 1.2MB) / 100만
= (242,000 + 48,000) / 1,000,000
= 3.0 MB/방문 (캐시 미적용 상한)
```

---

## 🔄 5. 캐시 보정 시나리오

### 상황별 계산 (월 100만 방문 기준)

| 시나리오 | MB/방문 | 월 전송량 | 월 비용 | 설명 |
|---------|--------|---------|--------|------|
| **상한 (캐시 없음)** | 3.0MB | 3TB | $360 | DevTools Disable Cache |
| **보수적 (0.7)** | 2.1MB | 2.1TB | $252 | 30% 캐시 히트 |
| **낙관적 (0.4)** | 1.2MB | 1.2TB | $144 | 60% 캐시 히트 |
| **이상적 (CDN+압축)** | 0.5MB | 0.5TB | $60 | Gzip 70% + CDN 캐시 80% |

**가정:**
- 이미지 캐시: 24시간 (HTTP Cache-Control)
- 데이터: 메모리 캐시 (Firestore Lite SDK)
- CDN: 상위 20% 파일이 80% 트래픽 차지

---

## 6️⃣ 6. Firestore READ 비용 분석

### 월 100만 견적 + 100만 방문 기준

| 동작 | 빈도/월 | READs/회 | 월 총 READ | 비용 |
|-----|--------|---------|-----------|------|
| **요청 목록 조회** | 1.0M | 20 | 20M | $1.20 |
| **채팅 메시지 로드** | 0.5M | 50 | 25M | $1.50 |
| **파트너 프로필** | 0.3M | 2 | 0.6M | $0.04 |
| **견적 제출 (체크)** | 1.0M | 1 | 1M | $0.06 |
| **메시지 실시간 구독** | (활성 중) | +1/메시지 | 5M* | $0.30 |
| **채팅 실시간 구독** | (활성 중) | +1/변화 | 3M* | $0.18 |
| **검색/필터** | 0.2M | 20 | 4M | $0.24 |
| **기타 조회** | - | - | 15M | $0.90 |
| **합계** | | | **73.6M** | **$4.42** |

*실시간 구독은 "문서 변경 감지"마다 READ 발생 (기존 지표 보다 높을 수 있음)

**주의**: 현재 구독 설계가 비효율적일 가능성 높음
- ☑️ 개선 시: 50M READs → $3.0 (32% 절감)

---

## 💰 7. 월 비용 계산 (전체 통합)

### 입력값 템플릿 (사용자가 채우기)

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 Firebase 월 비용 예측 (구조 기반)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] 트래픽 규모
    월 방문수:  ________ 만 명
    월 견적요청: ________ 만 건

[2] 네트워크 (Hosting 제외)
    평균 MB/방문 (캐시 미적용): ________ MB
    예상 캐시 보정계수:         ________ (0.4~0.7 또는 0.3)
    월 Egress 전송량:           ________ TB
    (자동 계산: TB = 방문 × MB ÷ 1000000)

[3] Firestore
    월 READ 작업수: ________ 백만
    월 WRITE 작업수: ________ 백만
    평균 문서 크기: ________ KB
    구독 활성도: 높음 / 중간 / 낮음

[4] Cloud Functions
    월 호출 수: ________ 만 회
    평균 실행시간: ________ ms

[5] Storage
    월 다운로드: ________ GB
    월 업로드: ________ GB
    평균 파일 크기: ________ MB

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔢 자동 계산 결과
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Firestore Reads:  $_____ ([1]의 값 × $0.06/10만)
Firestore Writes: $_____ ([3] WRITE × $0.18/10만)
Network Egress:   $_____ ([2]의 TB × $0.12)
Cloud Functions:  $_____ ([4] × $0.40/100만)
Storage (DL):     $_____ ([5] DL × $0.024)
Storage (Upload): $_____ ([5] Upload 무료)

┌─────────────────────────────────────┐
│ 월 예상 비용: $______ ~ $______     │
│ (최소: 보정 0.7 / 최대: 보정 0.4)  │
└─────────────────────────────────────┘
```

---

## 8️⃣ 8. 현재 상태 진단 (modoo-dev)

### 구조 점수 (100점 기준)

| 항목 | 점수 | 피드백 |
|------|------|--------|
| **이미지 최적화** | 65/100 | ⚠️ 썸네일 크기 줄였으나, Egress 문제는 여전 |
| **Firestore 설계** | 60/100 | ⚠️ 구독 과다 (limit으로 개선했으나 여전히 높음) |
| **캐싱 전략** | 40/100 | 🔴 HTTP Cache-Control 미적용, 메모리 캐시 없음 |
| **Function 비용** | 85/100 | ✅ deductPointsForQuote 잘 구현됨 |
| **데이터 구조** | 75/100 | ⚠️ hot/cold 분리 미흡 (message archive 대기) |
| **전체 점수** | **65/100** | 🟡 개선 중 단계 |

---

## 🚀 9. 단계별 개선 로드맵 (우선순위)

### Phase 1: 긴급 (1주 내)
- [ ] HTTP Cache-Control 헤더 추가 (70% Egress 절감)
- [ ] Firestore Lite SDK 도입 (READ 비용 50% 절감)
- 예상 절감: **월 $30,000**

### Phase 2: 중기 (2-4주)
- [ ] Cloud CDN 또는 CloudFlare 연동
- [ ] 메시지 구독 → 수동 페이지네이션 전환
- [ ] Ledger → Cloud Logging 전환
- 예상 절감: **월 $20,000**

### Phase 3: 장기 (1-2개월)
- [ ] 이미지 자동 Webp 변환 (Cloud Functions)
- [ ] 메시지 archive (30일 이후 cold storage)
- [ ] Firestore 인덱스 최적화
- 예상 절감: **월 $10,000**

**누적 절감 효과**: $60,000 → $12,000 (80%)

---

## 📋 10. 최종 질문지 (5개 항목)

아래를 채워오면 **정확한 월 비용 예측**이 가능합니다:

### Q1. 트래픽 규모
```
월 방문예상: ___만 명
월 견적요청: ___만 건
(또는 현재 월 실제 수치)
```

### Q2. 네트워크 캐싱
```
적용할 캐시 보정계수를 선택하세요:
□ 0.4 (낙관적: CDN + Gzip 모두 적용)
□ 0.5 (중간: CDN만 적용)
□ 0.7 (보수적: HTTP 캐시만 적용)
□ 1.0 (캐시 미적용, 상한선)
```

### Q3. Firestore 사용패턴
```
주로 어떤 기능을 많이 쓰나요?
□ 채팅 (메시지 구독 빈번)
□ 견적 조회 (읽기 위주)
□ 혼합 (균등)
```

### Q4. 이미지 업로드
```
월 평균 이미지 업로드 건수:
- 파트너 프로필: ___장/달
- 채팅 이미지: ___장/달
```

### Q5. 현재 사용량 (참고용)
```
지난 1개월 Firebase 콘솔 데이터:
- Firestore Reads: ___M
- Firestore Writes: ___M
- Storage 전송량: ___GB
(참고만 - 스케일링 계산 안 함)
```

---

## 📝 마지막 체크리스트

- [ ] 위 Q1~Q5를 채웠다
- [ ] 캐시 전략을 선택했다
- [ ] Phase 1 개선을 승인했다
- [ ] 예산 범위 ($12k~60k) 내 목표를 설정했다

**모두 완료 시 → 정확한 비용 모델 생성 가능 ✅**

---

*마지막 업데이트: 2026-02-01*
*작성자: Firebase Architecture Team*
