# 빌드 단계
FROM node:20-slim AS builder

WORKDIR /build

# 전체 소스 복사
COPY . .

# pnpm 설치 및 의존성 설정
RUN npm install -g pnpm@10.28.0 && \
    pnpm install --frozen-lockfile

# web 앱 빌드
WORKDIR /build/web
RUN pnpm build

# 프로덕션 단계
FROM node:20-slim

ENV NODE_ENV=production

WORKDIR /app

# standalone 결과물 복사
COPY --from=builder /build/web/.next/standalone/web ./

# static 및 public 복사
COPY --from=builder /build/web/.next/static ./.next/static
COPY --from=builder /build/web/public ./public

EXPOSE 8080

# 서버 시작
CMD ["node", "server.js"]
