rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // Helper Functions
    // ========================================

    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn() && request.auth.token.admin == true;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // ========================================
    // Customer Users
    // ========================================

    match /customerUsers/{userId} {
      // 읽기: 본인 또는 관리자
      allow read: if isOwner(userId) || isAdmin();

      // 생성: 본인만 (회원가입 시)
      allow create: if isOwner(userId);

      // 수정: 본인은 일반 필드만, 관리자는 모든 필드
      allow update: if isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['points', 'tier', 'status'])
                    || isAdmin();

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }

    // ========================================
    // Partner Users
    // ========================================

    match /partnerUsers/{userId} {
      // 읽기: 본인 또는 관리자
      allow read: if isOwner(userId) || isAdmin();

      // 생성: 본인만 (회원가입 시)
      allow create: if isOwner(userId);

      // 수정: 본인은 일반 필드만, 관리자는 모든 필드 (인증/구독/포인트 등)
      allow update: if isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                      'businessVerified', 'verificationStatus', 'grade',
                      'subscriptionStatus', 'subscriptionPlan', 'subscriptionEndDate',
                      'points'
                    ])
                    || isAdmin();

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }

    // ========================================
    // Partners (공개 프로필 + 운영 데이터)
    // ========================================

    match /partners/{partnerId} {
      // 읽기:
      // - get (단일 문서): 본인 또는 관리자
      // - list (검색): isActive == true인 문서만 공개 (고객 검색용)
      allow get: if isOwner(partnerId) || isAdmin();
      allow list: if signedIn() && resource.data.isActive == true;

      // 생성: 본인만 (최초 등록 시)
      allow create: if isOwner(partnerId);

      // 수정: 본인은 일반 필드만, 관리자는 모든 필드
      // 본인은 subscription.status, points.balance 등 운영 필드 직접 수정 불가
      // (앱 내부 로직에서 트랜잭션으로만 수정)
      allow update: if isOwner(partnerId) || isAdmin();

      // 삭제: 관리자만
      allow delete: if isAdmin();

      // photos 서브컬렉션은 더 이상 사용하지 않음 (Storage-only 정책)
      // 기존 데이터 마이그레이션 기간 동안 읽기만 허용
      match /photos/{photoId} {
        allow read: if isOwner(partnerId) || isAdmin();
        allow write: if false; // 신규 쓰기 차단
      }
    }

    // ========================================
    // Partner Ads (광고)
    // ========================================

    match /partnerAds/{adId} {
      // 읽기: active == true인 광고는 모든 로그인 사용자가 볼 수 있음
      allow read: if signedIn() && resource.data.active == true;

      // 생성: 광고 소유자
      allow create: if isAdmin()
        || (signedIn() && request.resource.data.partnerId == request.auth.uid);

      // 수정: 소유자 또는 관리자
      allow update: if signedIn() && (resource.data.partnerId == request.auth.uid || isAdmin());

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }

    // ========================================
    // Partner Verifications (사업자 인증 심사)
    // ========================================

    match /partnerVerifications/{userId} {
      // 읽기: 본인 또는 관리자
      allow read: if isOwner(userId) || isAdmin();

      // 생성: 본인만 (서류 제출 시)
      allow create: if isOwner(userId);

      // 수정: 본인은 서류 관련 필드만, 관리자는 심사 관련 필드 포함 모두 수정 가능
      allow update: if isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                      'status', 'rejectReason', 'reviewedAt', 'reviewedBy'
                    ])
                    || isAdmin();

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }

    // ========================================
    // Partner Payment/Point Ledger Collections
    // ========================================

    match /partnerPayments/{partnerId}/items/{itemId} {
      allow read: if isOwner(partnerId) || isAdmin();
      allow create: if isOwner(partnerId);
      allow update, delete: if isAdmin();
    }

    match /partnerPointLedger/{partnerId}/items/{itemId} {
      allow read: if isOwner(partnerId) || isAdmin();
      allow create: if isOwner(partnerId);
      allow update, delete: if isAdmin();
    }

    match /partnerPointOrders/{partnerId}/orders/{orderId} {
      allow read: if isOwner(partnerId) || isAdmin();
      allow create: if isOwner(partnerId);
      allow update, delete: if isAdmin();
    }

    // ========================================
    // Support Tickets
    // ========================================

    match /supportTickets/{ticketId} {
      // 읽기: 티켓 소유자 또는 관리자
      allow read: if signedIn() && (resource.data.userId == request.auth.uid || isAdmin());

      // 생성: 로그인한 사용자 (본인 userId로만)
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;

      // 수정: 소유자는 subject만, 관리자는 모든 필드
      allow update: if signedIn() && resource.data.userId == request.auth.uid
                       && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['subject', 'updatedAt'])
                    || isAdmin();

      // 삭제: 관리자만
      allow delete: if isAdmin();

      // 메시지 서브컬렉션
      match /messages/{messageId} {
        // 읽기: 티켓 소유자 또는 관리자
        allow read: if signedIn() && (get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId == request.auth.uid || isAdmin());

        // 생성: 소유자는 user 타입으로만, 관리자는 admin 타입으로
        allow create: if signedIn() && (
          (get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId == request.auth.uid
           && request.resource.data.senderType == 'user'
           && request.resource.data.senderId == request.auth.uid)
          || (isAdmin() && request.resource.data.senderType == 'admin')
        );

        // 수정/삭제: 불가
        allow update, delete: if false;
      }
    }

    // ========================================
    // Admin Audit Logs
    // ========================================

    match /adminAuditLogs/{logId} {
      // 읽기: 관리자만
      allow read: if isAdmin();

      // 생성: 관리자만
      allow create: if isAdmin();

      // 수정/삭제: 불가 (감사 로그는 불변)
      allow update, delete: if false;
    }

    // ========================================
    // Chat Rooms (Legacy - participants 배열 방식)
    // ========================================

    match /chatRooms/{roomId} {
      // 읽기: 참여자 또는 관리자
      allow read: if signedIn() && (request.auth.uid in resource.data.participants || isAdmin());

      // 생성: 로그인한 사용자
      allow create: if signedIn() && request.auth.uid in request.resource.data.participants;

      // 수정: 참여자만 (lastMessage 등)
      allow update: if signedIn() && request.auth.uid in resource.data.participants;

      // 삭제: 관리자만
      allow delete: if isAdmin();

      // 메시지 서브컬렉션
      match /messages/{messageId} {
        allow read: if signedIn() && (request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants || isAdmin());
        allow create: if signedIn() && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
        allow update, delete: if false;
      }
    }

    // ========================================
    // Chats (실제 사용 컬렉션 - customerId/partnerId 필드 방식)
    // ========================================

    match /chats/{chatId} {
      // 읽기: 참여자(customerId 또는 partnerId) 또는 관리자
      allow read: if signedIn() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid ||
        isAdmin()
      );

      // 생성: 로그인 사용자 (본인이 참여자로 포함)
      allow create: if signedIn() && (
        request.resource.data.customerId == request.auth.uid ||
        request.resource.data.partnerId == request.auth.uid
      );

      // 수정: 참여자만 (lastMessage, unreadCount 등)
      allow update: if signedIn() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid
      );

      // 삭제: 관리자만
      allow delete: if isAdmin();

      // 메시지 서브컬렉션
      match /messages/{messageId} {
        allow read: if signedIn() && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.customerId == request.auth.uid ||
          get(/databases/$(database)/documents/chats/$(chatId)).data.partnerId == request.auth.uid ||
          isAdmin()
        );
        allow create: if signedIn() && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.customerId == request.auth.uid ||
          get(/databases/$(database)/documents/chats/$(chatId)).data.partnerId == request.auth.uid
        );
        allow update, delete: if false;
      }
    }

    // ========================================
    // Requests (견적 요청)
    // ========================================

    match /requests/{requestId} {
      // 읽기: 로그인 사용자 (파트너가 목록을 볼 수 있어야 함)
      allow read: if signedIn();

      // 생성: 로그인 사용자
      allow create: if signedIn();

      // 수정: 요청자 또는 관리자
      allow update: if signedIn() && (resource.data.customerId == request.auth.uid || isAdmin());

      // 삭제: 관리자만
      allow delete: if isAdmin();

      // Quotes 서브컬렉션 (requests/{requestId}/quotes)
      match /quotes/{quoteId} {
        // 읽기: 로그인 사용자 (고객이 견적 목록 볼 수 있어야 함)
        allow read: if signedIn();

        // 생성/수정: 견적 작성 파트너 본인만
        allow create: if signedIn() && request.auth.uid == quoteId;
        allow update: if signedIn() && request.auth.uid == resource.data.partnerId;

        // 삭제: 관리자만
        allow delete: if isAdmin();
      }
    }

    // ========================================
    // Quotes (Legacy top-level - 사용 안 함)
    // ========================================

    match /quotes/{quoteId} {
      // 읽기: 요청자, 견적 작성 파트너, 또는 관리자
      allow read: if signedIn() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.partnerId == request.auth.uid ||
        isAdmin()
      );

      // 생성: 파트너
      allow create: if signedIn();

      // 수정: 작성자 또는 관리자
      allow update: if signedIn() && (resource.data.partnerId == request.auth.uid || isAdmin());

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }


    // ========================================
    // Reviews (customer/partner read)
    // ========================================

    match /reviews/{reviewId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.customerId == request.auth.uid;
      allow update: if signedIn() && resource.data.customerId == request.auth.uid;
      allow delete: if isAdmin();

      match /photos/{photoId} {
        allow read: if signedIn();
        allow write: if signedIn() && get(/databases/$(database)/documents/reviews/$(reviewId)).data.customerId == request.auth.uid;
      }
    }

    // ========================================
    // Notifications
    // ========================================

    match /notifications/{notificationId} {
      allow read: if signedIn() && resource.data.uid == request.auth.uid;
      allow create: if signedIn();
      allow update: if signedIn() && resource.data.uid == request.auth.uid;
      allow delete: if signedIn() && resource.data.uid == request.auth.uid;
    }

    // ========================================
    // User Notifications (Alternative path)
    // ========================================

    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

  }
}
